#!/usr/bin/env bash

ROOT=$(dirname "$0")/..

function get_package
{
    python -c "from neo4j.meta import package; print(package)"
}

function set_package
{
    sed -i 's/^package = .*/package = "'$1'"/g' neo4j/meta.py
}

function get_version
{
    python -c "from neo4j.meta import version; print(version)"
}

function set_version
{
    sed -i 's/^version = .*/version = "'$1'"/g' neo4j/meta.py
}

function set_metadata_and_setup
{
    cd ${ROOT}

    # Capture original package metadata
    ORIGINAL_PACKAGE=$(get_package)
    ORIGINAL_VERSION=$(get_version)

    # Temporarily override package metadata
    set_package "$1"; shift
    set_version "$1"; shift

    # Create source distribution
    rm -rf ${ROOT}/dist 2> /dev/null
    rm -rf ${ROOT}/*.egg-info 2> /dev/null
    python setup.py $*

    # Reset to original package metadata
    set_package "${ORIGINAL_PACKAGE}"
    set_version "${ORIGINAL_VERSION}"

}

function setup
{
    ARGS="$*"

    # Legacy package; can be removed in 2.0
    set_metadata_and_setup "neo4j-driver" ${ARGS}

    set_metadata_and_setup "neo4j" ${ARGS}
}
